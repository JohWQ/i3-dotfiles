# Personal Zsh configuration file. It is strongly recommended to keep all
# shell customization and configuration (including exported environment
# variables such as PATH) in this file or in files sourced from it.
#
# Documentation: https://github.com/romkatv/zsh4humans/blob/v5/README.md.

# Periodic auto-update on Zsh startup: 'ask' or 'no'.
# You can manually run `z4h update` to update everything.
zstyle ':z4h:' auto-update      'no'
# Ask whether to auto-update this often; has no effect if auto-update is 'no'.
zstyle ':z4h:' auto-update-days '28'

# Keyboard type: 'mac' or 'pc'.
zstyle ':z4h:bindkey' keyboard  'pc'

# Don't start tmux.
zstyle ':z4h:' start-tmux       no

# Mark up shell's output with semantic information.
zstyle ':z4h:' term-shell-integration 'yes'

# Right-arrow key accepts one character ('partial-accept') from
# command autosuggestions or the whole thing ('accept')?
zstyle ':z4h:autosuggestions' forward-char 'accept'

# Recursively traverse directories when TAB-completing files.
zstyle ':z4h:fzf-complete' recurse-dirs 'no'

# Enable direnv to automatically source .envrc files.
zstyle ':z4h:direnv'         enable 'no'
# Show "loading" and "unloading" notifications from direnv.
zstyle ':z4h:direnv:success' notify 'yes'

# Enable ('yes') or disable ('no') automatic teleportation of z4h over
# SSH when connecting to these hosts.
zstyle ':z4h:ssh:example-hostname1'   enable 'yes'

# custom ssh teleporting
zstyle ':z4h:ssh:192.168.10.254'   enable 'no'

#zstyle ':z4h:ssh:*.example-hostname2' enable 'no'
# The default value if none of the overrides above match the hostname.
zstyle ':z4h:ssh:*'                   enable 'no'

# Send these files over to the remote host when connecting over SSH to the
# enabled hosts.
zstyle ':z4h:ssh:*' send-extra-files '~/.nanorc' '~/.env.zsh'

# Clone additional Git repositories from GitHub.
#
# This doesn't do anything apart from cloning the repository and keeping it
# up-to-date. Cloned files can be used after `z4h init`. This is just an
# example. If you don't plan to use Oh My Zsh, delete this line.
z4h install ohmyzsh/ohmyzsh || return
#z4h install MichaelAquilina/zsh-auto-notify || return

# custom install plugin
z4h install fdw/yazi-zoxide-zsh || return

# Use additional Git repositories pulled in with `z4h install`.
#
# This is just an example that you should delete. It does nothing useful.
z4h source ohmyzsh/ohmyzsh/lib/diagnostics.zsh  # source an individual file

# custom source plugin
z4h source fdw/yazi-zoxide-zsh/yazi-zoxide-zsh.plugin.zsh 

z4h load   ohmyzsh/ohmyzsh/plugins/emoji-clock  # load a plugin

# Source additional local files if they exist.
z4h source ~/.env.zsh

# Install or update core components (fzf, zsh-autosuggestions, etc.) and
# initialize Zsh. After this point console I/O is unavailable until Zsh
# is fully initialized. Everything that requires user interaction or can
# perform network I/O must be done above. Everything else is best done below.
z4h init || return

# Extend PATH.
path=(~/bin $path)

# Export environment variables.
export GPG_TTY=$TTY


# ----- custom paths ----- #
eval "$(zoxide init zsh)"
source <(fzf --zsh)

export SHELL='/usr/local/bin/zsh'
export TERMINAL='alacritty'
export TERM="xterm-256color"
export BROWSER='firefox'
export EDITOR='nvim'
export VISUAL='nvim'
export GOPATH=$HOME/go
export PATH=$PATH:$GOROOT/bin:$GOPATH/bin
export PATH="$HOME/.cargo/bin:$PATH"
. "$HOME/.cargo/env"

# Exclude file paths from fd search in fzf.
# Customize as you see fit:
export FZF_DEFAULT_COMMAND='fd -H -t f \
-E "cache*" \
-E "Cache*" \
-E ".cache*" \
-E "cookies*" \
-E "Cookies*" \
-E ".git" \
-E ".github" \
-E ".npm" \
-E "Code Cache" \
-E "CacheStorage" \
-E "ScriptCache" \
-E "Session Storage" \
-E "sessionData" \
-E "Service Worker" \
-E "/sys/" \
-E "/mnt/" \
-E "/usr/src/" \
-E ".snapshots/" \
-E "home/.snapshots/" \
-E "home/$USER/.nv/" \
-E "home/$USER/.terminfo/" \
-E "home/$USER/.terminfo/" \
-E "home/$USER/.steam/" \
-E "home/$USER/.mozilla/" \
-E "home/$USER/.cargo/registry/" \
-E "home/$USER/.cargo/git/" \
-E "home/$USER/.local/state/" \
-E "home/$USER/.local/lib/" \
-E "home/$USER/.local/share/Steam/" \
-E "home/$USER/.local/share/nvim/" \
-E "home/$USER/.local/share/gvfs-metadata/" \
-E "home/$USER/.local/share/Smart Code ltd/" \
-E "home/$USER/JW-SERVER/div/games/ludusavi-backup/" \
-E ".nv/" \
-E ".terminfo/" \
-E ".rustup/" \
-E ".steam/" \
-E ".mozilla/" \
-E ".cargo/registry/" \
-E ".cargo/git/" \
-E ".local/state/" \
-E ".local/lib/" \
-E ".local/share/Steam/" \
-E ".local/share/nvim/" \
-E ".local/share/gvfs-metadata/" \
-E ".local/share/Smart Code ltd/" \
-E "JW-SERVER/div/games/ludusavi-backup/"'
# ------------------------ #


# Define key bindings.
z4h bindkey z4h-backward-kill-word  Ctrl+Backspace     Ctrl+H
z4h bindkey z4h-backward-kill-zword Ctrl+Alt+Backspace

z4h bindkey undo Ctrl+/ Shift+Tab  # undo the last command line change
z4h bindkey redo Alt+/             # redo the last undone command line change

z4h bindkey z4h-cd-back    Alt+Left   # cd into the previous directory
z4h bindkey z4h-cd-forward Alt+Right  # cd into the next directory
z4h bindkey z4h-cd-up      Alt+Up     # cd into the parent directory
z4h bindkey z4h-cd-down    Alt+Down   # cd into a child directory

# ----- custom binds ----- #
bindkey -r "\M-C\M-8"
bindkey -r "\M-C\M-^X"
z4h bindkey autosuggest-execute Alt+E
z4h bindkey autosuggest-toggle Alt+T
# ----------------- #

# Autoload functions.
autoload -Uz zmv

# Define functions and completions.
function md() { [[ $# == 1 ]] && mkdir -p -- "$1" && cd -- "$1" }
compdef _directories md

# Define named directories: ~w <=> Windows home directory on WSL.
[[ -z $z4h_win_home ]] || hash -d w=$z4h_win_home

# Define aliases.
alias tree='tree -a -I .git'

# ---------- custom aliases ---------- #
# ---------------------------
# Navigation / Directories
# ---------------------------
eval "$(zoxide init --cmd cd zsh)"
function cd() {
    # Use zoxide's built-in cd logic
    if [[ "$#" -eq 0 ]]; then
        builtin cd ~
    else
        __zoxide_z "$@"
    fi

    # Only proceed if cd was successful
    if [[ $? -eq 0 ]]; then
        echo "Files in current path: $(eza --all | wc -l)"
        eza --icons --color=always --almost-all --show-symlinks --only-dirs
    fi
}

alias ..='cd ..'
alias cd..='cd ..'

# ---------------------------
# Listing / File management
# ---------------------------
alias l='eza --icons --color=always --only-dirs'
alias ll='eza --icons --color=always --only-dirs --tree --level=1 --all'
alias ls='eza --icons --color=always --group-directories-first --almost-all -s modified'
alias la='eza --icons --color=always --group-directories-first -all -s modified'
alias l.='ls -ld .?*'
alias dir='ls'
alias catt='head -n 1 '
alias lsblk='lsblk -o NAME,UUID,FSUSE%,SIZE,MOUNTPOINT,MODEL'
alias fdfind='fd -H'

# ---------------------------
# Editors / Configs
# ---------------------------
alias bashrc='nvim ~/.bashrc'
alias zshrc='nvim ~/.zshrc'
alias i3config='nvim ~/.config/i3/config'
alias i3statusconfig1='nvim ~/.config/i3status-rust/config.toml'
alias i3statusconfig2='nvim ~/.config/i3status-rust/config.toml'
alias picomconfig='nvim ~/.config/picom/picom.conf'
alias yaziconfig='nvim ~/.config/yazi/yazi.toml'

# ---------------------------
# Shell management
# ---------------------------
alias tmux='tmux -q has-session && tmux attach-session -d || exec tmux new-session'
alias cls='clear'
alias clr='clear'
alias :q='exit'
alias zsh='clear; zsh; reset'
alias bash='clear; bash'
alias sudo='sudo '
alias trash='gio trash'
function gc() {
    git clone "$1" && cd "$(basename "$1" .git)" || return
}
alias gitbranchdates='git for-each-ref --sort=-committerdate --format="%(refname:short) - %(committerdate:relative)" refs/heads/'
alias gituntrack='git rm --cached '
alias gits='git status'
alias gitc='git commit -m'
alias gitd='git diff'
alias gita='git add .'
alias gitsearch='git ls-files | rg'

# ---------------------------
# System / Boot
# ---------------------------
alias grubupdate='sudo grub2-mkconfig -o /boot/grub2/grub.cfg'
alias uefiboot='systemctl reboot --firmware-setup'
alias uefiupdate='sudo fwupdmgr update'
alias nogui='sudo systemctl set-default multi-user.target && ~/.config/scripts/power/reboot.sh'
alias yesgui='sudo systemctl set-default graphical.target && systemctl restart lightdm'
alias guistatus='printf "GUI:\n"
systemctl is-active graphical.target
printf "TTY:\n"
systemctl is-active multi-user.target'
# ---------------------------
# Package Management (dnf)
# ---------------------------
alias dnfs='~/.config/scripts/pkgdnf.sh'
alias dnfi='sudo dnf install '
alias dnfr='echo "Careful!"; sudo dnf remove '
alias update='sudo dnf update'
alias updatestatus='sudo dnf update --assumeno; echo "\nprevious update history:\n"; dnf history info'

# ---------------------------
# Networking / Debug
# ---------------------------
alias ipconfig='ifconfig'
alias nvidiadebug='sudo nvidia-bug-report.sh && sleep 1; zcat nvidia-bug-report.log.gz | fpaste'
alias plist='pgrep -fl . | fzf'
alias pingtest='~/.config/scripts/ping_websites.sh'

# ---------------------------
# Scripts / Tools
# ---------------------------
isactive() {
    local isactive_input="$1"
    pgrep -fl "$isactive_input"
    systemctl status | rg "$isactive_input"
}
alias picom='picom --daemon --config ~/.config/picom/picom.conf'
alias neofetch='clear; fastfetch'
alias songrecord='songrec listen -d "alsa_output.pci-0000_00_1f.3.analog-stereo.monitor"'
alias localsend='sudo systemctl stop firewalld; localsend; systemctl start firewalld'
alias ocr='~/.config/scripts/ocr.sh'
alias showfont='fc-list : family | rg --ignore-case '
alias xpropinfo='xprop | rg -e WM_CLASS -e WM_NAME -e WM_NORMAL_HINTS'
alias rmpc='mpd-mpris -host 127.0.0.1 > /dev/null 2>&1 & ~/.cargo/bin/rmpc; pkill mpd-mpris'


# ----- custom autocorrect ----- #
# opts to enable
#setopt correctall
setopt hash_list_all
setopt correct
# zsh variable to determine what to ignore,
# in this case everything starting with _ or . 
# example:
correct_ignore="[_|.]*"
correct_ignore="[rpm|vim]*"
# programs missing option autocomplete:
compdef _gnu_generic fpaste pastel picom lightdm betterlockscreen pw-cli pw-dump dnf diff eza rofi xrandr fzf i3bar i3status-rs caligula
# ----------------------- #

# add flags to existing aliases.
#alias ls="${aliases[ls]:-ls} -a"

# Set shell options: http://zsh.sourceforge.net/Doc/Release/Options.html.
setopt glob_dots     # no special treatment for file names with a leading dot
setopt no_auto_menu  # require an extra TAB press to open the completion menu
